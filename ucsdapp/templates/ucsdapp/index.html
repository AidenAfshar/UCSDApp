<!DOCTYPE html>
<html>
  <head>
  </head>
  <body onload="init();">
    <h1>Take a snapshot of the current video stream</h1>
   Click on the Start WebCam button.
     <p>
    <button onclick="startWebcam();">Start WebCam</button>
       <button onclick="snapshot();">Take Snapshot</button> 
    </p>
    <video onclick="snapshot(this);" width=400 height=400 id="video" autoplay></video>
  <p>

        Screenshots : <p>
      <canvas  id="myCanvas" width="400" height="350"></canvas>
   </p>
   <p id = "photoText"></p>
  </body>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>

      //--------------------
      // GET USER MEDIA CODE
      //--------------------
          navigator.getUserMedia = ( navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia);

      var video;
      var webcamStream;
      const screenshotImage = document.querySelector('img');
            
      function startWebcam() {
        if (navigator.getUserMedia) {
           navigator.getUserMedia (

              // constraints
              {
                 video: true,
                 audio: false,
                 facingMode: {exact: 'environment'},
              },

              // successCallback
              function(localMediaStream) {
                  video = document.querySelector('video');
                  video.srcObject=localMediaStream;
                  awebcamStream = localMediaStream;
              },

              // errorCallback
              function(err) {
                 console.log("The following error occured: " + err);
              }
           );
        } else {
           console.log("getUserMedia not supported");
        }  
      }
      
      var canvas, ctx;

      function init() {
        canvas = document.getElementById("myCanvas");
        ctx = canvas.getContext('2d');

     }

     function drawbackground(canvas, context, onload){

         var imagePaper = new Image();
            imagePaper.onload = function(){
               context.drawImage(imagePaper,100, 20, 500,500);
               onload(canvas, context);
            };
         imagePaper.src = "images/main_timerand3papers.png";
         }

     function snapshot () {
         canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
         var text = canvas.toDataURL('image/png', 1.0);
         
         text = text.slice(22);

         $.ajax({
            type: "POST",
            url: "{{ 'my-ajax-test/' }}",
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', text: text },
            success: function callback(response){
               response = JSON.parse(response);
               var originalCoords;
               var prevCoords;
               var fullText = String(Object.keys(response)).split("\n");
               for (var i = 0; i < (fullText.length); i++) {
                  var wordList = fullText[i].split(" ");
                  ctx.beginPath();
                  if (wordList.length == 1) {
                     for (let j = 0; j < 4; j++) {
                        response[wordList][j] = response[wordList][j].replace('(', '');
                        response[wordList][j] = response[wordList][j].replace(')', '');
                        coords = response[wordList][j].split(',');
                        if (j == 0) {
                           ctx.moveTo(parseInt(coords[0]), parseInt(coords[1]));
                           originalCoords = coords;
                        }
                        else {
                           ctx.lineTo(parseInt(coords[0]), parseInt(coords[1]));
                        }
                     }
                     ctx.lineTo(parseInt(originalCoords[0]), parseInt(originalCoords[1]));
                     ctx.strokeStyle = "blue";
                     ctx.stroke();
                  }
                  else {
                     for (let b = 0; b < 4; b++) {
                        response[wordList[0]][b] = response[wordList[0]][b].replace('(', '');
                        response[wordList[0]][b] = response[wordList[0]][b].replace(')', '');
                        coords = response[wordList[0]][b].split(',');
                        if (b == 0) {
                           ctx.moveTo(parseInt(coords[0]), parseInt(coords[1]));
                           originalCoords = coords;
                           prevCoords = coords;
                        }
                        else if ((b == 1) || (b == 2)) {
                           response[wordList[(wordList.length-1)]][b] = response[wordList[(wordList.length-1)]][b].replace('(', '');
                           response[wordList[(wordList.length-1)]][b] = response[wordList[(wordList.length-1)]][b].replace(')', '');
                           coords = response[wordList[(wordList.length-1)]][b].split(',');
                           ctx.moveTo(parseInt(prevCoords[0]), parseInt(prevCoords[1]));
                           ctx.lineTo(parseInt(coords[0]), parseInt(coords[1]));
                           prevCoords = coords;
                        }
                        else {
                           ctx.moveTo(parseInt(prevCoords[0]), parseInt(prevCoords[1]));
                           ctx.lineTo(parseInt(coords[0]), parseInt(coords[1]));
                           prevCoords = coords;
                           
                        }
                     }
                     ctx.moveTo(parseInt(prevCoords[0]), parseInt(prevCoords[1]));
                     ctx.lineTo(parseInt(originalCoords[0]), parseInt(originalCoords[1]));
                     ctx.strokeStyle = "blue";
                     ctx.stroke();
                  }
               }
               document.getElementById("photoText").innerHTML = response;
            }
         });
      };
  </script>
</html>