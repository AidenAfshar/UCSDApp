<!DOCTYPE html>
<html>
  <head>
  </head>
  <body onload="init();">
    <h1>Take a snapshot of the current video stream</h1>
   Click on the Start WebCam button.
     <p>
    <button onclick="startWebcam();">Start WebCam</button>
       <button onclick="snapshot();">Take Snapshot</button> 
    </p>
    <video onclick="snapshot(this);" width=400 height=400 id="video" autoplay></video>
  <p>

        Screenshots : <p>
      <canvas  id="myCanvas" width="400" height="350"></canvas>  
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>

      //--------------------
      // GET USER MEDIA CODE
      //--------------------
          navigator.getUserMedia = ( navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia);

      var video;
      var webcamStream;
      const screenshotImage = document.querySelector('img');
            
      function startWebcam() {
        if (navigator.getUserMedia) {
           navigator.getUserMedia (

              // constraints
              {
                 video: true,
                 audio: false,
                 facingMode: {exact: 'environment'},
              },

              // successCallback
              function(localMediaStream) {
                  video = document.querySelector('video');
                  video.srcObject=localMediaStream;
                  awebcamStream = localMediaStream;
              },

              // errorCallback
              function(err) {
                 console.log("The following error occured: " + err);
              }
           );
        } else {
           console.log("getUserMedia not supported");
        }  
      }
      /*
      function send_data() {
        $.ajax({
            url : 'the_url',
            data : {
               'csrfmiddlewaretoken' : '<the-token>',
               'key1' : 'val1',
            },
            method : 'POST',
            success : success_function // reference to below
         });
      
 // ---------/c\zw-98310--/--\---------
    // TAKE A SNAPSHOT CODE
      //-----------------=----
      // trigger send_data on some event:
      $('<the-selector').on('<some-event>', {}, send_data);

      // i.e. send data on button click:
      $('#button-id').on('click', {}, send_data);

      // success function:
      function success_function(response) {

      // unpack response:
      val2 = response.key2;

      // do some logic:
      ...

      }
      }
      */

      // ----------------------
      // TAKE A SNAPSHOT CODE
      //-----------------=----
      var canvas, ctx;

      function init() {
        // Get the canvas and obtain a context for
        // drawing in it
        canvas = document.getElementById("myCanvas");
        ctx = canvas.getContext('2d');

     }

     function drawbackground(canvas, context, onload){

         var imagePaper = new Image();
            imagePaper.onload = function(){
               context.drawImage(imagePaper,100, 20, 500,500);
               onload(canvas, context);
            };
         imagePaper.src = "images/main_timerand3papers.png";
         }

     function snapshot () {
         canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
         //screenshotImage.src = canvas.toDataURL('image/webp');
         //screenshotImage.classList.remove('d-none');
         var text = canvas.toDataURL('image/png', 1.0);
         
         text = text.slice(22);

         $.ajax({
            type: "POST",
            url: "{{ 'my-ajax-test/' }}",
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', text: text },
            success: function callback(response){
                        console.log(response);
                        ctx.beginPath();
                        ctx.rect(20, 20, 150, 100);
                        ctx.strokeStyle = "blue"
                        ctx.stroke();
                        var imagePaper = new Image();
                        imagePaper.onload = function(){
                           context.drawImage(imagePaper, 100, 20, 500,500);
                           onload(canvas, context);
                        };
                        imagePaper.src = "images/main_timerand3papers.png";
                     }
         });
      };
      /*
      function snapshot() {
         // Draws current image from the video element into the canvas
         ctx.drawImage(video, 0,0, canvas.width, canvas.height - 50);
         var dataURL = canvas.toDataURL("image/png");
         
         //var newTab = window.open('about:blank','image from canvas');
         //newTab.document.write("<img src='" + dataURL + "' alt='from canvas'/>");
         //alert(dataURL)

         var text = dataURL;

         $.ajax({
            type: "POST",
            url: "{{ 'my-ajax-test/' }}",
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', text: text },
            success: function callback(response){
                        console.log(response);
                     }
         });
      }
      */
         

/*
var a = document.createElement('a');
a.href = "img.png";
a.download = "output.png";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
*/


  </script>
</html>
<!--<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display Webcam Stream</title>
 
<style>
#container {
	margin: 0px auto;
	width: 500px;
	height: 375px;
	border: 10px #333 solid;
}
#videoElement {
	width: 500px;
	height: 375px;
	background-color: #666;
}
</style>
</head>
 
<body>
<div id="container">
	<video autoplay="true" id="videoElement">
	
	</video>
</div>
<script>
    var video = document.querySelector("#videoElement");

    if (navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
        video.srcObject = stream;
        })
        .catch(function (err0r) {
        console.log("Something went wrong!");
        });
    }
</script>
</body>
</html>
-->